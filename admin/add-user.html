<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add User</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="../firebase-config.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>



<style>
body{
    margin:0;
    background:#f4f4f4;
    font-family:Poppins,sans-serif;
    overflow-x: hidden;   /* ⭐ horizontal scroll बंद */
}

/* TOP BAR */
.top-bar{
    background:#e59b15;
    color:white;
    padding:20px;
    position:fixed;
    width:100%;
    top:0;
    left:0;
    border-bottom-left-radius:25px;
    border-bottom-right-radius:25px;
    z-index:1000;
}
.top-bar h2{ margin:21px; }

/* TABS SECTION */
.tab-container{
    position: fixed;
    top:110px;
    left:0;
    width:100%;
    background:#f4f4f4;
    padding:12px 10px;
    display:flex;
    justify-content: space-between;
    gap:15px;
    z-index:900;
}

.tab-btn{
    flex:1;
    padding:16px;
    border:none;
    border-radius:10px;
    background:#ffdcb0;
    font-size:18px;
    font-weight:bold;
    cursor:pointer;
    text-align:center;
    margin-right: 60px;
    margin-left:40px;
}

.tab-active{
    background:#e59b15 !important;
    color:white;
}

/* FORM BOX */
.form-box{
    margin-top:190px;
    width:92%;
    margin-left:auto;
    margin-right:auto;
    background:white;
    padding:20px;
    border-radius:15px;
    box-shadow:0px 4px 14px rgba(0,0,0,0.12);
}

/* ALL INPUTS SAME WIDTH */
input, select{
    width:100%;
    padding:13px;
    border:1px solid #ccc;
    border-radius:10px;
    margin-bottom:15px;
    font-size:18px;
    box-sizing:border-box;
}

/* BUTTON */
.btn{
    width:100%;
    padding:14px;
    background:#0f4bff;
    color:white;
    border:none;
    border-radius:10px;
    font-size:18px;
    cursor:pointer;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
}

/* LOADER */
.loader{
    border:3px solid white;
    border-top:3px solid transparent;
    width:18px;
    height:18px;
    border-radius:50%;
    animation:spin 0.8s linear infinite;
    display:none;
}

@keyframes spin{
    100%{ transform:rotate(360deg); }
}

/* IMPORT FILE SECTION FIX */
#excelFile{
    width:100%;
}
/* ----------------------------
   ⭐ MOBILE RESPONSIVE FIX
----------------------------- */
@media (max-width: 600px) {

    body {
        padding: 0;
        overflow-x: hidden;
    }
    /* -----------------------------------
   ⭐ MOBILE ONLY HORIZONTAL SCROLL FIX
------------------------------------*/
@media (max-width: 600px) {

    html, body {
        width: 100%;
        overflow-x: hidden !important;
        margin: 0;
        padding: 0;
    }

    /* FORM BOX width control */
    .form-box {
        width: 100% !important;
        margin: 150px auto 20px auto !important;
        padding: 15px !important;
        box-sizing: border-box;
    }

    /* TAB CONTAINER overflow fix */
    .tab-container {
        width: 100% !important;
        padding: 18px !important;
        gap: 8px !important;
        box-sizing: border-box;
    }

    /* TAB BUTTON overflow fix */
    .tab-btn {
        flex: 1;
        margin: 0 !important;
        padding: 10px !important;
        font-size: 14px !important;
        box-sizing: border-box;
    }

    /* Any input should never overflow */
    input, select {
        width: 100% !important;
        box-sizing: border-box;
    }
}

@media (max-width: 600px) {

    .tab-container {
        width: 100%;
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
        box-sizing: border-box;
    }

    .tab-btn {
        flex: 1;
        margin: 0 !important;
        padding: 12px !important;
        font-size: 15px;
        border-radius: 10px;
        text-align: center;
    }
}

    /* TOP BAR */
    .top-bar {
        padding: 15px;
    }
    .top-bar h2 {
        font-size: 20px;
        margin: 10px;
    }

    /* TAB BUTTONS */
    .tab-container {
        top: 70px;
        padding: 10px;
        gap: 10px;
    }

    .tab-btn {
        font-size: 14px;
        padding: 10px;
        margin: 0 !important;
    }

    /* FORM BOX */
    .form-box {
        margin-top: 140px;
        padding: 15px;
        width: 94%;
    }

    /* INPUTS */
    input,
    select {
        padding: 11px;
        font-size: 15px;
        margin-bottom: 13px;
    }

    /* BUTTON */
    .btn {
        padding: 12px;
        font-size: 16px;
        border-radius: 10px;
    }

    /* Loader Size small for mobile */
    .loader {
        width: 16px;
        height: 16px;
    }
}


</style>
</head>

<body>

<div class="top-bar">
    <h2>Add User</h2>
</div>

<!-- TABS -->
<div class="tab-container">
    <button class="tab-btn tab-active" id="btnManual" onclick="switchType('manual')">Manual</button>
    <button class="tab-btn" id="btnImport" onclick="switchType('import')">Import Excel</button>
</div>

<!-- MANUAL FORM -->
<div id="manualForm" class="form-box">

    <select id="role">
        <option value="">Select Role</option>
        <option value="student">Student</option>
        <option value="teacher">Teacher</option>
        <option value="admin">Admin</option>
    </select>

    <div id="studentFields">
        <select id="classSelect">
            <option value="">Select Class (Only Student)</option>
            <option>Nursery</option>
            <option>LKG</option>
            <option>UKG</option>
            <option>1st</option>
            <option>2nd</option>
            <option>3rd</option>
            <option>4th</option>
            <option>5th</option>
            <option>6th</option>
            <option>7th</option>
            <option>8th</option>
            <option>9th</option>
            <option>10th</option>
            <option>11th</option>
            <option>12th</option>
        </select>

        <input id="roll" type="number" placeholder="Roll Number (Only Student)">
    </div>

    <input id="fullName" type="text" placeholder="Full Name">
    <input id="username" type="text" placeholder="Username">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">

    <select id="gender">
        <option value="">Select Gender</option>
        <option>Male</option>
        <option>Female</option>
    </select>

    <input id="dob" type="date" placeholder="DOB">
    <input id="phone" type="text" placeholder="Phone">
    <input id="year" type="text" placeholder="Session (ex: 2025-26)">

    <button class="btn" id="addBtn" onclick="submitUser()">
        <span id="btnText">Add User</span>
        <div class="loader" id="btnLoader"></div>
    </button>

</div>

<!-- IMPORT EXCEL PANEL -->
<div id="importForm" class="form-box" style="display:none; text-align:center;">
    <h3>Import From Excel</h3>
    <p>Upload Excel file of users.</p>
    <input type="file" id="excelFile">
  <button class="btn" onclick="uploadExcel()" id="uploadBtn">
    <span id="uploadText">Upload</span>
    <div class="loader" id="uploadLoader"></div>
</button>

</div>

<script>
function cleanText(value) {
    if (!value) return "";
    return value.toString().trim().replace(/\s+/g, " ");
}

function cap(value) {
    if (!value) return "";
    value = cleanText(value);
    return value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
}

/* TAB SWITCH */
function switchType(type){
    if(type === "manual"){
        document.getElementById("manualForm").style.display = "block";
        document.getElementById("importForm").style.display = "none";

        btnManual.classList.add("tab-active");
        btnImport.classList.remove("tab-active");
    }
    else{
        document.getElementById("manualForm").style.display = "none";
        document.getElementById("importForm").style.display = "block";

        btnImport.classList.add("tab-active");
        btnManual.classList.remove("tab-active");
    }
}



/* Show / Hide Student Fields */
document.getElementById("role").addEventListener("change", function(){
   if(this.value === "student"){

        studentFields.style.display = "block";
    } else {
        studentFields.style.display = "none";
    }
});

studentFields.style.display = "none"; // default hidden
/* ⭐ ADD USER FUNCTION ⭐ */
async function submitUser() {

    // INPUT VALUES
    let role = cap(document.getElementById("role").value);
    let className = cleanText(document.getElementById("classSelect").value);
    let fullName = cap(document.getElementById("fullName").value);
    let username = cleanText(document.getElementById("username").value);
    let email = cleanText(document.getElementById("email").value);
    let password = document.getElementById("password").value;
    let gender = cap(document.getElementById("gender").value);
    let dob = document.getElementById("dob").value;
    let phone = cleanText(document.getElementById("phone").value);
    let year = cleanText(document.getElementById("year").value);
    let roll = cleanText(document.getElementById("roll").value);

    // VALIDATION
    if (!fullName || !email || !password) {
        alert("Fill all required fields!");
        return;
    }

    // START LOADING
    addBtn.disabled = true;
    btnText.style.display = "none";
    btnLoader.style.display = "block";

    try {

        // CREATE AUTH USER
        let userCred = await firebase.auth()
            .createUserWithEmailAndPassword(email, password);

        let uid = userCred.user.uid;

        // SAVE IN USERS COLLECTION
        await db.collection("users").doc(uid).set({
            name: fullName,
            username: username,
            email: email,
            phone: phone,
            dob: dob,
            gender: gender,
            role: role,
            class: className,
            roll: roll,
            year: year,
            uid: uid
        });

        // IF STUDENT → save in second path
        if (role.toLowerCase() === "student") {
            await db.collection("students")
                .doc(className)
                .collection("classStudents")
                .doc(uid)
                .set({
                    name: fullName,
                    roll: roll,
                    gender: gender,
                    class: className,
                    uid: uid
                });
        }

        alert("User Added Successfully!");

        // RESET FORM
        document.getElementById("role").value = "";
        document.getElementById("classSelect").value = "";
        document.getElementById("fullName").value = "";
        document.getElementById("roll").value = "";
        document.getElementById("username").value = "";
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
        document.getElementById("gender").value = "";
        document.getElementById("dob").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("year").value = "";

    } catch (err) {
        alert(err.message);
    }

    // STOP LOADING
    addBtn.disabled = false;
    btnText.style.display = "block";
    btnLoader.style.display = "none";
}

function cleanText(value) {
    if (!value) return "";
    return value.toString().trim().replace(/\s+/g, " ");
}

function capitalize(value) {
    if (!value) return "";
    value = cleanText(value);
    return value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
}

/* ADD USER FUNCTION */
async function uploadExcel() {

    let file = document.getElementById("excelFile").files[0];
    if (!file) {
        alert("Please select an Excel file!");
        return;
    }

    // START LOADER
    uploadBtn.disabled = true;
    uploadText.style.display = "none";
    uploadLoader.style.display = "block";

    let reader = new FileReader();

    reader.onload = async function(e) {

        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, { type: "array" });

        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let rows = XLSX.utils.sheet_to_json(sheet);

        console.log("Rows loaded:", rows);
  function excelDateToJSDate(excelDate) {
            if (!excelDate) return "";
            return new Date((excelDate - 25569) * 86400 * 1000)
                .toISOString()
                .split("T")[0];}
        for (let row of rows) {
       // CLEAN + FORMAT
            let fullName = cap(row.fullname);
            let username = cleanText(row.username);
            let email = cleanText(row.email);
            let phone = cleanText(row.phone);
            let gender = cap(row.gender);
            let role = cap(row.role);
            let className = cleanText(row.class);
            let roll = cleanText(row.roll);
            let year = cleanText(row.year);

            // Required fields check
            if (!row.email || !row.password) {
                alert("Missing email/password in Excel row. Skipping...");
                continue;
            }
         
            /* ---------------------------
               ⭐ FIX DOB FORMAT HERE
               --------------------------- */
            let dob = "";

            if (row.dob) {

                // If Excel gives serial number (e.g. 45550)
                if (!isNaN(row.dob)) {
                    let excelDate = XLSX.SSF.parse_date_code(row.dob);
                    dob = `${excelDate.d}-${excelDate.m}-${excelDate.y}`;
                } 
                else {
                    // If Excel gives "YYYY-MM-DD"
                    let d = new Date(row.dob);
                    let day = d.getDate().toString().padStart(2, '0');
                    let month = (d.getMonth() + 1).toString().padStart(2, '0');
                    let year = d.getFullYear();
                    dob = `${day}-${month}-${year}`;
                }
            }

            try {
                // 1️⃣ Create user in AUTH
                let userCred = await firebase.auth()
                      .createUserWithEmailAndPassword(row.email, row.password);

                let uid = userCred.user.uid;

                // 2️⃣ USERS PATH
    await db.collection("users").doc(uid).set({
    name: fullName,
    username: username,
    email: email,
    phone: phone,
    dob: dob,
    gender: gender,
    role: role,
    class: className,
    roll: roll,
    year: year,
    uid: uid
});



                // 3️⃣ STUDENT PATH (only if student)
            if (role.toLowerCase() === "student") {

await db.collection("students")
    .doc(className)
    .collection("classStudents")
    .doc(uid)
    .set({
        name: fullName,
        roll: roll,
        gender: gender,
        class: className,
        uid: uid
    });

                }

            } catch (err) {
                console.error("Import Error: ", err.message);
                alert("Error: " + err.message);
            }
        }

        alert("Excel Imported Successfully!");

        // STOP LOADER
        uploadBtn.disabled = false;
        uploadText.style.display = "block";
        uploadLoader.style.display = "none";
              document.getElementById("excelFile").value = "";
    };

    reader.readAsArrayBuffer(file);
}


</script>

</body>
</html>
